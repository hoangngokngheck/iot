<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Smart Home Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {font-family: Arial; background:#f4f6f9; color:#2c3e50; margin:0; padding:0;}
    h1 {color:#34495e; text-align:center; padding:20px 0; margin:0; background:#ecf0f1;}
    .container {display:grid; grid-template-columns:1fr 2fr; gap:20px; padding:20px;}
    .card {background:white; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1); padding:20px;}
    .switch {position:relative; display:inline-block; width:60px; height:34px;}
    .switch input {display:none;}
    .slider {position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:34px;}
    .slider:before {position:absolute; content:''; height:26px; width:26px; left:4px; bottom:4px; background:white; transition:.4s; border-radius:50%;}
    input:checked+.slider {background-color:#4CAF50;}
    input:checked+.slider:before {transform:translateX(26px);}
    button {padding:10px 20px; margin:10px; font-size:16px; border:none; border-radius:8px; background:#3498db; color:white; cursor:pointer;}
    .right {display:grid; grid-template-rows:auto auto; gap:15px;}
    .charts {display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;}
    canvas {height:120px !important; width:100% !important;}
    @media(max-width:768px){.container{grid-template-columns:1fr;}.charts{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <h1>üè† Smart Home Dashboard (MQTT Cloud)</h1>
  <div class="container">
    <div class="card">
      <h3>ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã</h3>
      <p><b>Ch·∫ø ƒë·ªô hi·ªán t·∫°i:</b> <span id="modeText">ƒêang t·∫£i...</span></p>
      <button onclick="toggleMode()">ƒê·ªïi Auto/Manual</button>

      <p>üí° ƒê√®n: <span id="lampText">--</span><br>
        <label class="switch">
          <input type="checkbox" id="lampToggle" onclick="toggleDevice('lamp')" disabled>
          <span class="slider"></span>
        </label>
      </p>

      <p>üíß M√°y phun s∆∞∆°ng: <span id="mistText">--</span><br>
        <label class="switch">
          <input type="checkbox" id="mistToggle" onclick="toggleDevice('mist')" disabled>
          <span class="slider"></span>
        </label>
      </p>

      <p>üå¨ Qu·∫°t: <span id="fanText">--</span><br>
        <label class="switch">
          <input type="checkbox" id="fanToggle" onclick="toggleDevice('fan')" disabled>
          <span class="slider"></span>
        </label>
      </p>
    </div>

    <div class="card right">
      <div>
        <h3>D·ªØ li·ªáu c·∫£m bi·∫øn</h3>
        <p>Nhi·ªát ƒë·ªô: <span id="temp">--</span> ¬∞C</p>
        <p>ƒê·ªô ·∫©m: <span id="humi">--</span> %</p>
        <p>√Ånh s√°ng: <span id="light">--</span></p>
      </div>

      <div class="charts">
        <canvas id="tempChart"></canvas>
        <canvas id="humiChart"></canvas>
        <canvas id="lightChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ==== MQTT Setup ====
    const broker = "wss://2f8582b1ea9e4ba7ac6af96398a28585.s1.eu.hivemq.cloud:8884/mqtt";
    const options = {
      username: "hoangphung",
      password: "Hoang05052004",
      reconnectPeriod: 2000,
      connectTimeout: 4000
    };
    const client = mqtt.connect(broker, options);
    let currentMode = 1;

    // ==== Charts ====
    const labels = [], tempData = [], humiData = [], lightData = [];
    const tempChart = new Chart(document.getElementById("tempChart"), {
      type:"line", data:{labels, datasets:[{label:"Nhi·ªát ƒë·ªô (¬∞C)", data:tempData, borderColor:"red", fill:false}]}
    });
    const humiChart = new Chart(document.getElementById("humiChart"), {
      type:"line", data:{labels, datasets:[{label:"ƒê·ªô ·∫©m (%)", data:humiData, borderColor:"blue", fill:false}]}
    });
    const lightChart = new Chart(document.getElementById("lightChart"), {
      type:"line", data:{labels, datasets:[{label:"√Ånh s√°ng", data:lightData, borderColor:"orange", fill:false}]}
    });

    // ==== MQTT Events ====
    client.on("connect", ()=>{
      console.log("‚úÖ MQTT connected");
      client.subscribe("ptit/home/status");
      client.publish("ptit/home/control", "REQ_STATUS");
    });

    client.on("message", (topic, message)=>{
      if(topic==="ptit/home/status"){
        const data = JSON.parse(message.toString());
        updateUI(data);
      }
    });

    function send(cmd){
      client.publish("ptit/home/control", cmd);
      console.log("üì§ Sent:", cmd);
    }

    // ==== UI Update ====
    function updateUI(data){
      document.getElementById("temp").innerText = data.temp.toFixed(1);
      document.getElementById("humi").innerText = data.humi.toFixed(1);
      document.getElementById("light").innerText = data.light ? "S√°ng" : "T·ªëi";

      document.getElementById("lampText").innerText = data.lamp ? "ƒêang b·∫≠t" : "ƒêang t·∫Øt";
      document.getElementById("mistText").innerText = data.mist ? "ƒêang b·∫≠t" : "ƒêang t·∫Øt";
      document.getElementById("fanText").innerText  = data.fan ? "ƒêang b·∫≠t" : "ƒêang t·∫Øt";

      document.getElementById("lampToggle").checked = data.lamp;
      document.getElementById("mistToggle").checked = data.mist;
      document.getElementById("fanToggle").checked  = data.fan;

      currentMode = data.autoMode;
      document.getElementById("modeText").innerText = currentMode ? "AUTO ü§ñ" : "MANUAL ‚úã";

      document.getElementById("lampToggle").disabled = currentMode;
      document.getElementById("mistToggle").disabled = currentMode;
      document.getElementById("fanToggle").disabled  = currentMode;

      const now = new Date().toLocaleTimeString();
      if(labels.length>20){labels.shift();tempData.shift();humiData.shift();lightData.shift();}
      labels.push(now);
      tempData.push(data.temp); humiData.push(data.humi); lightData.push(data.light);
      tempChart.update(); humiChart.update(); lightChart.update();
    }

    function toggleDevice(dev){
      if(currentMode) return;
      const st = document.getElementById(dev+"Toggle").checked;
      send(dev.toUpperCase() + "_" + (st ? "ON" : "OFF"));
    }
    function toggleMode(){ send(currentMode ? "MODE_MANUAL" : "MODE_AUTO"); }
  </script>
</body>
</html>
